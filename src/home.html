<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Radio SWITCH | ZSI Kielce</title>
<link href='http://fonts.googleapis.com/css?family=Droid+Serif' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<link href="css/songs.css" rel="stylesheet" type="text/css" />
<link href="css/styles.css" rel="stylesheet" type="text/css" />
<link rel="icon" 
      type="image/png" 
      href="/images/favicon.png">
</head>
<body>
<div class="menu-wrap">
  <div class="menu">
	<div class="elementymenu">
    <ul>
      <li class="first"><a href="index.html" class="active">HOME</a></li>
      <li><a target="_blank" href="http://zsi.kielce.pl/">Strona ZSI</a></li>
      <li><a href="audycje.html">Audycje</a>  </li>
      <li><a href="projekt.html">Projekt</a>  </li>
      <li><a href="sklad.html">Skład</a></li>
      <li><a href="zamow.php">Koncert życzeń </a></li>
      <li><a href="sprzet.html">Sprzęt</a></li>
      <li><a href="contact.php">Kontakt</a></li>
    </ul>
	</div>
  </div>
</div>

<div class="clearing"></div>
<div class="header">
  <div class="logo">
    <h1><img src="images/LOGO.png"></h1>
  </div>
  <div class="social">
    <ul>
	  <li><a target="_blank" href="https://www.facebook.com/zsikielce/"><img src="images/facebook.png" alt="ZSI" /></a><font style="font-size:14px; color:#d13f31; font-family: 'Oswald', sans-serif; font-weight:normal; text-transform:uppercase;">/ ZSI</font></li>
	  <li><a target="_blank" href="https://www.facebook.com/zsiswitch/"><img src="images/facebook.png" alt="SWITCH" /></a><font style="font-size:14px; color:#d13f31; font-family: 'Oswald', sans-serif; font-weight:normal; text-transform:uppercase;">/ SWITCH</font></li>
      <li><a target="_blank" href="https://www.last.fm/user/switchzsi/"><img src="images/lastfm2.png" alt="SWITCH" /></a><font style="font-size:14px; color:#d13f31; font-family: 'Oswald', sans-serif; font-weight:normal; text-transform:uppercase;">/ SWITCH</font></li>
    </ul>
  </div>
</div>

  
<div class="pasek"></div>

<div class="page">
  <div class="generic">
    <div class="panel p2">
      <h1>Teraz gramy</h1>
      <div class="songs">
        <div id="d1"><noscript><h3>Wystąpił błąd w trakcie pobierania danych!</h3></noscript></div>
        <div id="d2"><noscript><h4>Twoja przeglądarka nie ma włączonej funkcji JavaScript.</h4></noscript></div>
        <div id="d3"></div>
      </div>
      
      <div><a href="https://www.last.fm/user/switchzsi/library" target="_blank">Pokaż starsze</a></div>
    </div>
  </div>
</div>

<br>
<div class="banner">
  <h1>Radiowęzeł SWITCH </h1>
  <h2>Made by ZSI Kielce</h2>
</div>


  <div class="copyright-wrap">
    <div class="panel">
      <div class="content">
        <P>Copyright (c) Radio SWITCH | Designed by <a href="http://patryk.org/">Patryk Piotrowski</a>. </P>
      </div>
    </div>
  </div>
</body>


<script>
    /*
 * v: 1.0.1-0614
 */

var ws = new WebSocket('wss://localhost:8080/ws');
var template = "<span class='time'><img class='currp' src='images/playing.png' /> %%_TIME_BEGIN_%% </span><span class='title'><a href='%%_SONG_URL_%%' target='_blank'>%%_SONG_TITLE_%%</a></span><span class='author'> by <a href='%%_AUTHOR_URL_%%' target='_blank'>%%_AUTHOR_NAME_%%</a></span>";
var monthNames = [
    "stycznia", "lutego", "marca",
    "kwietnia", "maja", "czerwca", "lipca",
    "sierpnia", "wrzeĹnia", "paĹşdziernika",
    "listopada", "grudnia"
  ];

var position = [
  document.getElementById('d1'),
  document.getElementById('d2'),
  document.getElementById('d3')
];

function change_song(obj) {
  var dat = new Date(obj.date * 1000)

	let min  = dat.getMinutes();
	if (min < 10)
		min = "0" + min;
	
	let h  = dat.getHours();
	if (h < 10)
		h = "0" + h;

	position[2].innerHTML = position[1].innerHTML;
	position[1].innerHTML = position[0].innerHTML;
	position[0].innerHTML = template.replace("%%_AUTHOR_URL_%%", "https://www.last.fm/music/" + obj.artist.replace(new RegExp(' ', 'g'), '+'))
								  .replace("%%_AUTHOR_NAME_%%", obj.artist)
								  .replace("%%_SONG_URL_%%", "https://www.last.fm/music/" + obj.artist.replace(new RegExp(' ', 'g'), '+') +"/_/" + obj.title.replace(new RegExp(' ', 'g'), '+'))
								  .replace("%%_SONG_TITLE_%%", obj.title)
								  .replace("%%_TIME_BEGIN_%%", h + ":" + min);
}

ws.onopen = function() {
	console.log("opened");
	position[0].innerHTML = "<h4>Brak piosenek.</h4>";
};

ws.onclose = function(event) {
  console.log(event)
	console.log("closed");
	position[0].innerHTML = "<h4>PoĹÄczenie zostaĹo zamkniÄte!</h4>";
	position[1].innerHTML = "<h4>SprĂłbuj ponownie za jakiĹ czas.</h4>";
	position[2].innerHTML = "";
};

ws.onerror = function(event){
    console.log("Error");
    console.log(event)
}

ws.onmessage = function(event) {
	if (event.data.length == 0) {
		ws.close();
		position[0].innerHTML = "<h3>WystÄpiĹ bĹÄd w trakcie pobierania danych!</h3>";
		position[1].innerHTML = "<h4>SprĂłbuj ponownie za jakiĹ czas.</h4>";
		return;
	}
	console.log(event.data);
	
	var data = JSON.parse(event.data);

  if (data.msg_type == -1){
    return;
  }

  // todo: zmiana obecnie granej
  if (data.msg_type == 0) {
    console.log("ZMIANA!")
    position[0].classList.remove("currp")
    return
  }

  for (let i = data.data.length - 1; i >= 0; i--) {
    const val = data.data[i];
    change_song(val)
  }
	
};
</script>

</html>
